## Wave Software Development Challenge - Payroll API

This is API only Ruby on Rails based application solution to Wave's [se-challenge-payroll](https://github.com/wvchallenges/se-challenge-payroll) challenge. 
This is a MVP product with minimum functionalities.

### Live Demo
Live demo can be found at https://sa-payroll.herokuapp.com

### Tech Stack
* Ruby (3.0.2)
* Rails (6.1.4)
* PostgreSQL (13.3.1)

### Running Locally
Make sure above requirements are fulfilled before running this application.
Navigate to project directory and follow following commands

`bundle install` will install all the required gems.

`rails db:setup` command will install all the required gems.

`rails server` Rails Server will start and you can visit `localhost:3000` in your web browser.

### Running Tests
Run `rails spec` command from project folder.

### Assumptions
* Upload CSV file will be in `correct format` and there is no validation on csv rows.
* If csv contains zero records, I am still saving reference of the `report id` in the system, so another csv with same report id can't be uploaded.
* Once CSV is uploaded, `wages` will be calculated based on current `group rates`. If in future group rates change, old entries will have wages as per previous rates.

### Features
1. Upload a CSV file containing data on the number of hours worked per day per employee.
2. Retrieve a report detailing how much each employee should be paid in each _pay period_
3. `API Docs` using `Swagger`
4. Validation for valid CSV file format

### API End Points
 **`POST` `/api/file_imports`**

Replace `HOST` & `PATH_TO_CSV` in below curl requests.

File name should be of the format `time-report-x.csv`,
where `x` is the ID of the time report represented as an integer. 
For example, `time-report-42.csv` would represent a report with an ID of `42`.

```
curl -X POST "https://{HOST}/api/file_imports" -H  "Content-Type: multipart/form-data" -F "file_report[file]=@{PATH_TO_CSV};type=text/csv"
```
---
 **`GET` `/api/payroll_reports`**

```
curl -X GET "http://{HOST}/api/payroll_reports"
```

You can Test it on `Swagger UI` ([Live Link](https://sa-payroll.herokuapp.com))

![Screenshot](public/images/swagger_ui.png?raw=true "Swagger UI")


### Design
* This application API only application built using Ruby on Rails.
* For persistence, **Postgres** is being used. We have structured data and later on, we may want to perform complex queries to generate timesheet and other reports. So I choose SQL based database.

### Database Schema
Table Names: `file_imports` `time_logs`

| **file_imports** |           |
|------------------|-----------|
| report_id        | int(PK)   |
| `has_many`       |`time_logs`|


| **time_logs**   |             |
|-----------------|-------------|
| id              | int (PK)    |
| employee_id     | int         |
| date            | date        |
| hours_worked    | decimal     |
| job_group       | string      |
| report_id       | int (FK)    |
| wage_cents      | int         |
| wage_currency   | string      |
| `belongs_to`    |`file_import`|

> **NOTE**: `wage_cents` have `total wage` for the day based on `hours_worked` and `job_group`. Default currency is set to `CAD`. `money-rails` gem is used to monetize wage.

### Controllers
* `api/file_imports_controller.rb` is used to `upload` CSV File. It will create `FileImport` record which will have many `TimeLog` records in the DB.
* `api/payroll_reports_controller.rb`: Returns biweekly Payroll Report which is sorted by employee id and start duration.

### Services
* `ImportCsv`: Reads CSV file and persist data into the DB.
* `PayrollReportQuery`: Query database to create Payroll Report as per requirements.
* `PayrollReportTransformer`: Transforms/decorates report generated by `PayrollReportQuery` into expected output format.

## Q&A
#### How did you test that your implementation was correct?
* I have written Test Cases using rspec and swagger.
* Also used Swagger UI to manually verify the functionalities.  
* Specs verify following functionalities
   * If data is getting imported into database with valid CSV
   * API should return error if CSV with existing report_id is uploaded
   * API response of GET Payroll Report should match expected result. For reference `spec/files/time-report-1.csv` have been used.
   * If there is no data in the system, API should return empty data set.

#### If this application was destined for a production environment, what would you add or change?
* **API Authentication** - Only authenticated requests can access the system
* Having `separate models` for employee, payment groups. For this we should have employees, groups already created in the system.
* `Background processing` of CSV and maintain status of the job and errors if any.
* `Validation` on CSV data.
* `Export` report data in formats like CSV or XLS
* `Pagination` of results
* `Filters` based on date, employee id, group
* `Sorting` options based on employee id, wage, duration

#### What compromises did you have to make as a result of the time constraints of this challenge?
* For generation of Payroll Report, I am querying `TimeLog` table and grouping the records. 
  Instead we can have `PayrollReport` table and when CSV import is done, grouped data can be saved into `PayrollReport` table. Also this will depend on the usage of Payroll Report data.    
* If we upload file with 0 rows, we will not abe to upload file with same name again. This behaviour can be changed as per the requirements.
* I have `hardcoded` the `group rates` in the model itself and On CSV upload I am calculating `total wage` for each record which is getting saved into `wage_cents`field.
* Report records are `sorted` by `employee id` and then `pay period start`. We can't pass `sort by` in the api request.

> NOTE: I was getting some bundle error while running rubocop on my system. So i ran it from my another system and git commit history shows two users `Aman Kumar` and `aman29april`